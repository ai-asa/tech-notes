# はじめに
## 誰に向けたものです？
- FastMCPの実装をある程度理解しておきたい
- FastMCPが抽象化している概念を理解したい
- **むしろFastMCPを使わずにMCPを一から実装したい**

FastMCPの使い方が知りたい方は以下の記事をどうぞ
https://qiita.com/oohira/items/35e6eaaf4b44613ad7d3
  
## MCPについて
**Model Context Protocol（MCP）** は、LLMと外部システムを連携させるためにAnthoropic社によって標準化されたプロトコルです。AIアシスタントが様々なサービスと対話できる環境を構築します。

MCPサーバーは主に以下の機能を提供します：
1. **リソース**：読み取り専用データ（ファイル内容、API応答、データベース情報など）
2. **ツール**：LLMが呼び出せる関数（計算実行、API呼び出し、ファイル操作など）
3. **プロンプト**：再利用可能なテンプレートやワークフロー

## FastMCPについて
PythonでMCPサーバーを構築するための複雑な低レベル実装を抽象化して、**簡単かつ最小限のコードでMCPサーバーを構築できるようにしたフレームワーク**です。

開発当初は独立したプロジェクト(`jlowin/fastmcp`)でしたが、現在は公式のpython-SDKに統合されました。ライセンスもApache2.0 -> MITへ変更
https://github.com/modelcontextprotocol/python-sdk

# MCPの実装について
## 前提となる知識
### MPCの通信プロトコル
MCP の通信は、JSON-RPC 2.0 プロトコルに基づいています。クライアントとサーバ間の通信は、標準入出力（stdio）または HTTP with Server-Sent Events（SSE）トランスポートを通じて行われます。
{JSON-RPC 2.0の説明、実際のデータスキーマ例}
{stdioの説明、実際の例}
### SSE
{SSEの解説}
### ASGI
{ASGIの解説}

## MCPの主要な実装
### 構成
{MCPの実装において必要な要素、機能を整理}
### 簡単な実装
{FastMCPを使わずにMCPサーバーを構築するうえでの最小限の簡単な実装コード}

# FastMCPの実装と抽象化

## FastMCPが抽象化する主要な機能

FastMCPは、MCPサーバー実装の複雑さを隠蔽し、開発者が本質的な機能に集中できるよう、以下の主要な機能を抽象化しています：

1. **インターフェース実装**
   - デコレータパターンによる宣言的API設計

2. **プロトコル処理**
   - 型ヒントからJSON-RPC/MCPスキーマへの自動変換
   - 非同期コミュニケーションの管理
   - 複数トランスポート（stdio/SSE）の抽象化

3. **基盤機能**
   - コンテキスト機能の自動注入
   - URIベースのリソースシステム
   - ライフサイクル管理

## FastMCPの実装アプローチ

FastMCPは、Pythonの高度な機能を活用してMCPの複雑さを抽象化しています。特に関数デコレータ、型ヒント解析、asyncioベースの非同期処理、コンテキストパターンなどを組み合わせることで、開発者が簡潔で直感的なコードを書けるようにしています。

## 各抽象化機能の実装詳細

### デコレータパターンによる宣言的API

FastMCPは、Pythonのデコレータ機能を活用して、開発者が単純なデコレータを関数に付与するだけでMCP機能として登録できる宣言的なAPIを提供しています。

{例えば`@server.tool`デコレータを使用して関数を登録する例とコード例}

{FastMCPがデコレータパターンをどのように実装しているか。デコレータの背後にある設計思想、Python標準ライブラリの`inspect`モジュールの活用方法、関数が内部でどのように登録・管理されるか、実行時にどのようにディスパッチされるかなど、抽象化の全体像と主要な実装技術について説明。}

### 型ヒントからスキーマへの自動変換

FastMCPは、Pythonの型ヒントとdocstringを解析して、MCPプロトコルに必要なJSON Schemaを自動的に生成します。これにより、開発者は複雑なスキーマを手動で定義する必要がなくなります。

{関数メタデータを抽出し、型ヒントをJSON Schemaに変換するコード例}

{型変換システムの設計と実装方法。Pythonの型ヒント（typing）からJSON Schemaへの変換がどのように行われるか、Pydanticとの連携方法、複雑な型（ネストされた構造、ジェネリック型など）の処理方法、この抽象化によって開発者が手動で行う必要がなくなった作業について説明。}

### 非同期通信の管理

FastMCPは、asyncioを基盤とした非同期プログラミングモデルを採用し、同期処理と非同期処理を透過的に扱えるようにしています。リクエスト処理は方法に応じて適切なハンドラにディスパッチされます。

{JSON-RPCリクエストを適切なハンドラに振り分けるルーティングコード例}

{FastMCPの非同期処理アーキテクチャの概要。asyncioの活用方法、同期/非同期関数の自動判別と適切な実行方法、イベントループの管理、並行処理とキャンセル処理の仕組み、異なるトランスポート（stdio/SSE）間での共通抽象化レイヤーの実現方法について説明。}

### コンテキスト提供

FastMCPは、各リクエスト処理に対して専用のコンテキストオブジェクトを提供し、ログ記録、進捗報告、リソースアクセスなどの機能を簡単に利用できるようにしています。これにより、ハンドラ関数は必要な機能にアクセスしやすくなっています。

{Contextクラスの基本構造と主要メソッドの例}

{コンテキスト機能の設計思想と実装方法。コンテキストオブジェクト指向設計の利点、リクエスト間での状態分離の仕組み、コンテキストを通じた機能提供（ログ記録、進捗報告、リソースアクセスなど）の実現方法、依存性注入パターンの活用、リクエストライフサイクル全体を通じてのコンテキスト管理について説明。}

### URIベースのリソースシステム

FastMCPは、URIテンプレートを使った直感的なリソース定義と、効率的なパラメータ抽出機能を提供しています。リソースのURIパターンは正規表現に変換され、リクエスト時に効率的にマッチングされます。

{URIテンプレート処理と正規表現変換の例}

{URIベースリソースシステムの設計と実装方法。パスパラメータをサポートするURIテンプレート構文の設計、正規表現エンジンを活用したマッチングと優先順位の実装、パラメータ抽出と型変換の自動化、階層化されたリソース構造のサポート、この抽象化によって実現される柔軟なリソースアドレス指定について説明。}

## lifespan管理の実装

FastMCPは、サーバーの起動時と終了時に共有リソースを効率的に管理するための、lifespanコンテキストマネージャをサポートしています。これにより、データベース接続などの共有リソースをツール間で効率的に管理できます。

{lifespanセットアップと終了処理の実装例}

{サーバーライフサイクル管理の設計と実装方法。非同期コンテキストマネージャパターンの活用、アプリケーション状態の管理と共有、リソース初期化と終了処理の保証メカニズム、エラー処理とグレースフルシャットダウン、FastMCPの他のコンポーネントとのライフサイクル連携について説明。}

## 処理フロー
{FastMCPにおけるリクエスト処理の全体的なフロー。クライアントからリクエストが到着してからレスポンスが返されるまでの各段階、関与するコンポーネントとその相互作用、データの流れ、重要な分岐点とエラー処理の仕組みについて、シーケンス図やフロー図を用いて視覚的に説明。FastMCPの抽象化レイヤーがリクエスト処理全体をどのように簡素化しているかを強調。}

## まとめ

FastMCPは、MCPプロトコルの複雑さを様々なレベルで抽象化し、開発者が本質的な機能実装に集中できるようにします。デコレータ、型ヒント解析、非同期処理、コンテキスト提供などの技術を巧みに組み合わせることで、簡潔で直感的なAPIと強力な内部実装を両立させています。

これらの抽象化により、通常は多くのコードが必要な複雑なMCPサーバーが、少ないコードで実装可能になります。また、独自のMCPサーバーを実装する場合は、FastMCPの抽象化アプローチを参考にすることで、効率的な設計が可能になるでしょう。

